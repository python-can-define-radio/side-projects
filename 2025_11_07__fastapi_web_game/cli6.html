<!DOCTYPE html>
<html lang="en">

<head>
  <title>Avatar Selector</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    #game-container {
      display: none;
      /* hidden until Start is pressed */

      align-items: flex-start;
      gap: 20px;
    }

    #game-text {
      border: 1px solid #ccc;
      padding: 10px;
      width: 180px;
      background-color: #f8f8f8;
      border-radius: 6px;
      font-family: Arial, sans-serif;
    }

    #game-text p {
      margin: 6px 0;
    }

    canvas {
      border: 1px solid black;
    }
  </style>
</head>

<body>
  <div id="menu">
    <h2>Select Your Avatar</h2>
    <label>
      name:
      <input type="text" id="name" placeholder="Enter your name" autocomplete="name" />
    </label>
    <br><br>
    <label>
      Shape:
      <select id="shape">
        <option value="square">Square</option>
        <option value="circle">Circle</option>
        <option value="triangle">Triangle</option>
      </select>
    </label>
    <br><br>
    <label>
      Color:
      <input type="color" id="color" value="#00ff00" />
    </label>
    <br><br>
    <button id="startBtn">Start Game</button>
  </div>

  <div id="game-container">
    <canvas id="canvas" width="1000" height="1000"></canvas>

    <!-- ✅ Added Player Info Box -->
    <div id="game-text">
      <h3>Player Info</h3>
      <p><strong>Name:</strong> <span id="info-name">---</span></p>
      <p><strong>X:</strong> <span id="info-x">0</span></p>
      <p><strong>Y:</strong> <span id="info-y">0</span></p>
      <p><strong>Score:</strong> <span id="info-score">0</span></p>
    </div>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const menu = document.getElementById('menu');
    const gameContainer = document.getElementById('game-container');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // ✅ Player Info Elements
    const infoName = document.getElementById('info-name');
    const infoX = document.getElementById('info-x');
    const infoY = document.getElementById('info-y');
    const infoScore = document.getElementById('info-score');

    let userConfig = {};
    let score = 0; // placeholder
    let gstatic = {};

    // Load images ONCE
    const img = {};
    img["/assets/coinGold.png"] = new Image();
    img["/assets/brick2.png"] = new Image();
    img["/assets/tree.png"] = new Image();
    img["/assets/coinGold.png"].src = "/assets/coinGold.png";
    img["/assets/brick2.png"].src = "/assets/brick2.png";
    img["/assets/tree.png"].src = "/assets/tree.png";

    startBtn.addEventListener('click', () => {
      userConfig = {
        name: document.getElementById('name').value.trim() || "Anonymous",
        shape: document.getElementById('shape').value,
        color: document.getElementById('color').value,
        x: 0,
        y: 0,
      };

      // ✅ adds static name to info panel
      infoName.textContent = userConfig.name;

      menu.style.display = 'none';
      gameContainer.style.display = 'flex'; // show game + info panel

      startGame();
    });

    function draw(items, centerx, centery) {
      for (const cid of Object.keys(items)) {
        const { x, y, name, img_loc, img_size } = items[cid];
        const offsetx = x - centerx + canvas.width / 2;
        const offsety = y - centery + canvas.height / 2;
        const hsz = img_size / 2;
        if (img_loc && img_loc in img) {
          ctx.drawImage(img[img_loc], offsetx - hsz, offsety - hsz, img_size, img_size);
        } else {
          ctx.fillStyle = 'blue';
          ctx.fillRect(offsetx - 10, offsety - 10, 20, 20);
        }

        ctx.font = '12px Arial';
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        ctx.fillText(name, offsetx, offsety + 20);
      }
    }

    function startGame() {
      const socket = new WebSocket("ws://localhost:8000/ws");

      socket.onopen = function () {
        socket.send(JSON.stringify({
          eventkind: "init",
          name: userConfig.name,
          shape: userConfig.shape,
          color: userConfig.color
        }));
      };

      socket.onmessage = function (event) {
        try {
          const { dynamic, players } = JSON.parse(event.data);
          if (dynamic !== undefined) {

            // ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#cfc";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const playervals = Object.values(players);
            const me = playervals.find((p) => p.name == userConfig.name);

            userConfig.x = me.x;
            userConfig.y = me.y;

            // ✅ Update info panel live
            infoX.textContent = me.x.toFixed(0);
            infoY.textContent = me.y.toFixed(0);
            infoScore.textContent = score; // static for now

            draw(players, me.x, me.y);
            draw(dynamic, me.x, me.y);
            draw(gstatic, me.x, me.y)
          } else {
            const { static } = JSON.parse(event.data);
            if ( static !== undefined) {
              gstatic = static;
            } else {
              alert("Err: Didn't receive static Entity info, but was expecting to.")
            }
          }
        } catch (e) {
          console.error("onmessage error:", e);
        }
      };

      canvas.addEventListener("click", function (event) {
        const rect = canvas.getBoundingClientRect();
        const canvasx = event.clientX - rect.left;
        const worldadjustx = canvas.width / 2 - userConfig.x;
        const x = canvasx - worldadjustx;
        const canvasy = event.clientY - rect.top;
        const worldadjusty = canvas.height / 2 - userConfig.y;
        const y = canvasy - worldadjusty;

        socket.send(JSON.stringify({
          x, y,
          eventkind: "click",
        }));
      });

      addEventListener("keydown", function (event) {
        socket.send(JSON.stringify({
          key: event.key,
          eventkind: "keydown",
        }));
      });

      addEventListener("keyup", function (event) {
        socket.send(JSON.stringify({
          key: event.key,
          eventkind: "keyup",
        }));
      });
    }
  </script>
</body>

</html>